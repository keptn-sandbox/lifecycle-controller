apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  #  substitutes current time and namespace, making sure they are changed to env var first
  # to prevent bad files in case of a test interrupt
  - script: |
      current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
      initial_timestamp=$(date -u -d "$current_time" +%s)
      seconds_to_add=20
      new_timestamp=$((initial_timestamp + seconds_to_add))
      time_20_seconds_later=$(date -u -d "@$new_timestamp" +"%Y-%m-%dT%H:%M:%SZ")
      export CURRENT_TIME="$current_time"
      export LATER="$time_20_seconds_later"
      sed -i '0,/^  namespace:/s/namespace: .*/namespace: $NAMESPACE/' install.yaml
      sed -i 's/from: .*$/from: $CURRENT_TIME/g; s/to: .*$/to: $LATER/g' install.yaml
      echo "templating time" $CURRENT_TIME $LATER
      envsubst <"install.yaml" >out.yaml
      rm "install.yaml"
      mv out.yaml "install.yaml"
  - command: kubectl apply -f install.yaml
  #  rewrites the env var not to push useless date changes when running locally
  - script: |
      sed -i '0,/^  namespace:/s/namespace: .*/namespace: $NAMESPACE/' install.yaml
      sed -i 's/from: .*$/from: $CURRENT_TIME/g; s/to: .*$/to: $LATER/g' install.yaml
